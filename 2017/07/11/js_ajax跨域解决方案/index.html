<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="javascript," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="前言从刚接触前端开发起，跨域这个词就一直以很高的频率在身边重复出现，一直到现在，已经调试过N个跨域相关的问题了，16年时也整理过一篇相关文章，但是感觉还是差了点什么，于是现在重新梳理了一下。 个人见识有限，如有差错，请多多见谅，欢迎提出issue，另外看到这个标题，请勿喷~ 题纲关于跨域，有N种类型，本文只专注于ajax请求跨域(ajax跨域只是属于浏览器&amp;quot;同源策略&amp;quot;中的一部分">
<meta name="keywords" content="javascript">
<meta property="og:type" content="article">
<meta property="og:title" content="ajax跨域解决方案">
<meta property="og:url" content="https://keeppassionalways.github.io/2017/07/11/js_ajax跨域解决方案/index.html">
<meta property="og:site_name" content="郭天琦的前端博客">
<meta property="og:description" content="前言从刚接触前端开发起，跨域这个词就一直以很高的频率在身边重复出现，一直到现在，已经调试过N个跨域相关的问题了，16年时也整理过一篇相关文章，但是感觉还是差了点什么，于是现在重新梳理了一下。 个人见识有限，如有差错，请多多见谅，欢迎提出issue，另外看到这个标题，请勿喷~ 题纲关于跨域，有N种类型，本文只专注于ajax请求跨域(ajax跨域只是属于浏览器&amp;quot;同源策略&amp;quot;中的一部分">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrt17kyyj30tq0mz0vy.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrwgov9vj30nu0cn0up.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrxwhv61j30nw0cbjtl.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrz5hbo2j30nu0bu40c.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfs03b1naj30ya0megzm.jpg">
<meta property="og:updated_time" content="2017-07-11T06:56:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ajax跨域解决方案">
<meta name="twitter:description" content="前言从刚接触前端开发起，跨域这个词就一直以很高的频率在身边重复出现，一直到现在，已经调试过N个跨域相关的问题了，16年时也整理过一篇相关文章，但是感觉还是差了点什么，于是现在重新梳理了一下。 个人见识有限，如有差错，请多多见谅，欢迎提出issue，另外看到这个标题，请勿喷~ 题纲关于跨域，有N种类型，本文只专注于ajax请求跨域(ajax跨域只是属于浏览器&amp;quot;同源策略&amp;quot;中的一部分">
<meta name="twitter:image" content="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrt17kyyj30tq0mz0vy.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://keeppassionalways.github.io/2017/07/11/js_ajax跨域解决方案/"/>





  <title>ajax跨域解决方案 | 郭天琦的前端博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">郭天琦的前端博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">html5、css3、javascript、nodejs</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-html">
          <a href="/categories/html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-html5"></i> <br />
            
            html
          </a>
        </li>
      
        
        <li class="menu-item menu-item-css">
          <a href="/categories/css" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-css3"></i> <br />
            
            css
          </a>
        </li>
      
        
        <li class="menu-item menu-item-javascript">
          <a href="/categories/javascript" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-star"></i> <br />
            
            javascript
          </a>
        </li>
      
        
        <li class="menu-item menu-item-essay">
          <a href="/categories/随笔" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-coffee"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-folder"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'yourswiftypekey','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://keeppassionalways.github.io/2017/07/11/js_ajax跨域解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="郭天琦">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/toux.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="郭天琦的前端博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ajax跨域解决方案</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-11T11:05:31+08:00">
                2017-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从刚接触前端开发起，<code>跨域</code>这个词就一直以很高的频率在身边重复出现，一直到现在，已经调试过N个跨域相关的问题了，16年时也整理过一篇相关文章，但是感觉还是差了点什么，于是现在重新梳理了一下。</p>
<p>个人见识有限，如有差错，请多多见谅，欢迎提出issue，另外看到这个标题，请勿喷~</p>
<h2 id="题纲"><a href="#题纲" class="headerlink" title="题纲"></a>题纲</h2><p>关于跨域，有N种类型，本文只专注于<code>ajax请求跨域</code>(ajax跨域只是属于浏览器<code>&quot;同源策略&quot;</code>中的一部分,其它的还有Cookie跨域iframe跨域,LocalStorage跨域等这里不做介绍)，内容大概如下:</p>
<ul>
<li><p>什么是ajax跨域</p>
<ul>
<li><p>原理</p>
</li>
<li><p>表现(整理了一些遇到的问题以及解决方案)</p>
</li>
</ul>
</li>
<li><p>如何解决ajax跨域</p>
<ul>
<li><p>JSONP方式</p>
</li>
<li><p>CROS方式</p>
</li>
<li><p>代理请求方式</p>
</li>
</ul>
</li>
<li><p>如何分析ajax跨域</p>
<ul>
<li><p>http抓包的分析</p>
</li>
<li><p>一些示例</p>
</li>
</ul>
</li>
</ul>
<h2 id="什么是ajax跨域"><a href="#什么是ajax跨域" class="headerlink" title="什么是ajax跨域"></a>什么是ajax跨域</h2><h3 id="ajax跨域的原理"><a href="#ajax跨域的原理" class="headerlink" title="ajax跨域的原理"></a>ajax跨域的原理</h3><p>ajax出现请求跨域错误问题,主要原因就是因为浏览器的“同源策略”,可以参考<a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="external">浏览器同源政策及其规避方法(阮一峰)</a></p>
<h3 id="CROS请求原理"><a href="#CROS请求原理" class="headerlink" title="CROS请求原理"></a>CROS请求原理</h3><p>CORS是一个W3C标准，全称是<code>&quot;跨域资源共享&quot;</code>（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。</p>
<p>基本上目前所有的浏览器都实现了CORS标准,其实目前几乎所有的浏览器ajax请求都是基于CORS机制的,只不过可能平时前端开发人员并不关心而已(所以说其实现在CROS解决方案主要是考虑后台该如何实现的问题)。</p>
<p>关于CROS，强烈推荐阅读</p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="external">跨域资源共享 CORS 详解(阮一峰)</a></p>
<p>另外，这里也整理了一个实现原理图(简化版):</p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrt17kyyj30tq0mz0vy.jpg" alt=""></p>
<h4 id="如何判断是否是简单请求"><a href="#如何判断是否是简单请求" class="headerlink" title="如何判断是否是简单请求?"></a>如何判断是否是简单请求?</h4><p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。只要同时满足以下两大条件，就属于简单请求。</p>
<ul>
<li><p>请求方法是以下三种方法之一：HEAD,GET,POST</p>
</li>
<li><p>HTTP的头信息不超出以下几种字段：</p>
<ul>
<li><p>Accept</p>
</li>
<li><p>Accept-Language</p>
</li>
<li><p>Content-Language</p>
</li>
<li><p>Last-Event-ID</p>
</li>
<li><p>Content-Type(只限于三个值application/x-www-form-urlencoded、 multipart/form-data、text/plain)</p>
</li>
</ul>
</li>
</ul>
<p>凡是不同时满足上面两个条件，就属于非简单请求。</p>
<h4 id="ajax跨域的表现"><a href="#ajax跨域的表现" class="headerlink" title="ajax跨域的表现"></a>ajax跨域的表现</h4><p>说实话，我记得当初整理过一篇文章，然后作为了一个解决方案，但是后来发现仍然有很多人还是不会。无奈只能耗时又耗力的调试。然而就算是我来分析，也只会根据对应的表现来判断是否是跨域，因此这一点是很重要的。</p>
<p>ajax请求时,如果存在跨域现象,并且没有进行解决,会有如下表现:(注意，是ajax请求，请不要说为什么http请求可以，而ajax不行，因为ajax是伴随着跨域的，所以仅仅是http请求ok是不行的)</p>
<p>注意:具体的后端跨域配置请看题纲位置。</p>
<p><strong>第一种现象:</strong> <code>No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource</code>, <strong>并且</strong> <code>The response had HTTP status code 404</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrwgov9vj30nu0cn0up.jpg" alt=""></p>
<p>出现这种情况的原因如下：</p>
<ul>
<li><p>本次ajax请求是“非简单请求”,所以请求前会发送一次预检请求(OPTIONS)</p>
</li>
<li><p>服务器端后台接口没有允许OPTIONS请求,导致无法找到对应接口地址</p>
</li>
</ul>
<p>解决方案: 后端允许options请求</p>
<p><strong>第二种现象:</strong> <code>No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource</code> <strong>并且</strong> <code>The response had HTTP status code 405</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrxwhv61j30nw0cbjtl.jpg" alt=""></p>
<p>这种现象和第一种有区别,这种情况下，后台方法允许OPTIONS请求,但是一些配置文件中(如<code>安全配置</code>),阻止了OPTIONS请求,才会导致这个现象</p>
<p>解决方案: 后端关闭对应的安全配置</p>
<p><strong>第三种现象:</strong> <code>No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource</code> <strong>并且</strong> <code>status 200</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfrz5hbo2j30nu0bu40c.jpg" alt=""></p>
<p>这种现象和第一种和第二种有区别,这种情况下，服务器端后台允许OPTIONS请求,并且接口也允许OPTIONS请求,但是头部匹配时出现不匹配现象</p>
<p>比如origin头部检查不匹配,比如少了一些头部的支持(如常见的<code>X-Requested-With</code>头部),然后服务端就会将response返回给前端,前端检测到这个后就触发XHR.onerror,导致前端控制台报错</p>
<p>解决方案: 后端增加对应的头部支持</p>
<p><strong>第四种现象:</strong> <code>heade contains multiple values &#39;*,*&#39;</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfs03b1naj30ya0megzm.jpg" alt=""></p>
<p>表现现象是，后台响应的http头部信息有两个<code>Access-Control-Allow-Origin:*</code></p>
<p>说实话，这种问题出现的主要原因就是进行跨域配置的人不了解原理，导致了重复配置，如:</p>
<ul>
<li><p>常见于.net后台(一般在web.config中配置了一次origin,然后代码中又手动添加了一次origin(比如代码手动设置了返回*))</p>
</li>
<li><p>常见于.net后台(在IIS和项目的webconfig中同时设置Origin:*)</p>
</li>
</ul>
<p>解决方案(一一对应):</p>
<ul>
<li><p>建议删除代码中手动添加的*，只用项目配置中的即可</p>
</li>
<li><p>建议删除IIS下的配置*，只用项目配置中的即可</p>
</li>
</ul>
<h2 id="如何解决ajax跨域"><a href="#如何解决ajax跨域" class="headerlink" title="如何解决ajax跨域"></a>如何解决ajax跨域</h2><p>一般ajax跨域解决就是通过JSONP解决或者CROS解决,如以下:(注意，现在已经几乎不会再使用JSONP了，所以JSONP了解下即可)</p>
<h2 id="JSONP方式解决跨域问题"><a href="#JSONP方式解决跨域问题" class="headerlink" title="JSONP方式解决跨域问题"></a>JSONP方式解决跨域问题</h2><p>jsonp解决跨域问题是一个比较古老的方案(实际中不推荐使用),这里做简单介绍(实际项目中如果要使用JSONP,一般会使用JQ等对JSONP进行了封装的类库来进行ajax请求)</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>JSONP之所以能够用来解决跨域方案,主要是因为 <script> 脚本拥有跨域能力,而JSONP正是利用这一点来实现。具体原理如图</p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfs2klppmj30p10jhtak.jpg" alt=""></p>
<h3 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h3><p>JSONP的实现步骤大致如下(参考了来源中的文章)</p>
<ul>
<li>客户端网页网页通过添加一个<script>元素，向服务器请求JSON数据，这种做法不受同源政策限制</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addScriptTag</span>(<span class="params">src</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">  script.setAttribute(<span class="string">"type"</span>,<span class="string">"text/javascript"</span>);</div><div class="line">  script.src = src;</div><div class="line">  <span class="built_in">document</span>.body.appendChild(script);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  addScriptTag(<span class="string">'http://example.com/ip?callback=foo'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'response data: '</span> + <span class="built_in">JSON</span>.stringify(data));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>请求时,接口地址是作为构建出的脚本标签的src的,这样,当脚本标签构建出来时,最终的src是接口返回的内容</p>
<ul>
<li>服务端对应的接口在返回参数外面添加函数包裹层</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">foo(&#123;</div><div class="line">  <span class="string">"test"</span>: <span class="string">"testData"</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>由于<script>元素请求的脚本，直接作为代码运行。这时，只要浏览器定义了foo函数，该函数就会立即调用。作为参数的JSON数据被视为JavaScript对象，而不是字符串，因此避免了使用JSON.parse的步骤。</li>
</ul>
<p>注意,一般的JSONP接口和普通接口返回数据是有区别的,所以接口如果要做JSONP兼容,需要进行判断是否有对应callback关键字参数,如果有则是JSONP请求,返回JSONP数据,否则返回普通数据</p>
<p><strong>使用注意</strong></p>
<p>基于JSONP的实现原理,所以JSONP只能是“GET”请求,不能进行较为复杂的POST和其它请求,所以遇到那种情况,就得参考下面的CROS解决跨域了(所以如今它也基本被淘汰了)</p>
<h2 id="CROS解决跨域问题"><a href="#CROS解决跨域问题" class="headerlink" title="CROS解决跨域问题"></a>CROS解决跨域问题</h2><p>CROS的原理上文中已经介绍了，这里主要介绍的是，实际项目中，后端应该如何配置以解决问题(因为大量项目实践都是由后端进行解决的)，这里整理了一些常见的后端解决方案:</p>
<h3 id="PHP后台配置"><a href="#PHP后台配置" class="headerlink" title="PHP后台配置"></a>PHP后台配置</h3><p>PHP后台得配置几乎是所有后台中最为简单的,遵循如下步骤即可:</p>
<ul>
<li>第一步:配置Php 后台允许跨域</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">header(<span class="string">'Access-Control-Allow-Origin: *'</span>);</div><div class="line">header(<span class="string">'Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept'</span>);</div><div class="line"><span class="comment">//主要为跨域CROS配置的两大基本信息,Origin和headers</span></div></pre></td></tr></table></figure>
<ul>
<li>第二步:配置Apache web服务器跨域(httpd.conf中)</li>
</ul>
<p>原始代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;Directory /&gt;</div><div class="line">    AllowOverride none</div><div class="line">    <span class="keyword">Require</span> all denied</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>改为以下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;Directory /&gt;</div><div class="line">    Options FollowSymLinks</div><div class="line">    AllowOverride none</div><div class="line">    Order deny,allow</div><div class="line">    Allow from all</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<h3 id="Node-js后台配置-express框架"><a href="#Node-js后台配置-express框架" class="headerlink" title="Node.js后台配置(express框架)"></a>Node.js后台配置(express框架)</h3><p>Node.js的后台也相对来说比较简单就可以进行配置。只需用express如下配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">app.all(&apos;*&apos;, function(req, res, next) &#123;</div><div class="line">    res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</div><div class="line">    res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;X-Requested-With&quot;);</div><div class="line">    res.header(&quot;Access-Control-Allow-Methods&quot;, &quot;PUT,POST,GET,DELETE,OPTIONS&quot;);</div><div class="line">    res.header(&quot;X-Powered-By&quot;, &apos; 3.2.1&apos;)</div><div class="line">        //这段仅仅为了方便返回json而已</div><div class="line">    res.header(&quot;Content-Type&quot;, &quot;application/json;charset=utf-8&quot;);</div><div class="line">    if(req.method == &apos;OPTIONS&apos;) &#123;</div><div class="line">        //让options请求快速返回</div><div class="line">        res.sendStatus(200); </div><div class="line">    &#125; else &#123; </div><div class="line">        next(); </div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="JAVA后台配置"><a href="#JAVA后台配置" class="headerlink" title="JAVA后台配置"></a>JAVA后台配置</h3><p>JAVA后台配置只需要遵循如下步骤即可:</p>
<ul>
<li>第一步:获取依赖jar包</li>
</ul>
<p>下载<a href="https://dailc.github.io/staticResource/blog/basicKnowledge/ajax/resource/cors-filter-2.4.jar">cors-filter-1.7.jar</a>, <a href="https://dailc.github.io/staticResource/blog/basicKnowledge/ajax/resource/java-property-utils-1.9.1.jar">java-property-utils-1.9.jar</a> 这两个库文件放到lib目录下。(放到对应项目的webcontent/WEB-INF/lib/下)</p>
<ul>
<li>第二步:如果项目用了Maven构建的,请添加如下依赖到pom.xml中:(非maven请忽视)</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;com.thetransactioncompany&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;cors-filter&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;[ version ]&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>其中版本应该是最新的稳定版本,CROS过滤器</p>
<ul>
<li>第三步:添加CROS配置到项目的Web.xml中( App/WEB-INF/web.xml)</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 跨域配置--&gt;    </div><div class="line">&lt;filter&gt;</div><div class="line">        &lt;!-- The CORS filter with parameters --&gt;</div><div class="line">        &lt;filter-name&gt;CORS&lt;/filter-name&gt;</div><div class="line">        &lt;filter-class&gt;com.thetransactioncompany.cors.CORSFilter&lt;/filter-class&gt;</div><div class="line"></div><div class="line">        &lt;!-- Note: All parameters are options, if omitted the CORS </div><div class="line">             Filter will fall back to the respective default values.</div><div class="line">          --&gt;</div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.allowGenericHttpRequests&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;true&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.allowOrigin&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;*&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.allowSubdomains&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;false&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.supportedMethods&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;GET, HEAD, POST, OPTIONS&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.supportedHeaders&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;Accept, Origin, X-Requested-With, Content-Type, Last-Modified&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.exposedHeaders&lt;/param-name&gt;</div><div class="line">            &lt;!--这里可以添加一些自己的暴露Headers   --&gt;</div><div class="line">            &lt;param-value&gt;X-Test-1, X-Test-2&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.supportsCredentials&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;true&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;cors.maxAge&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;3600&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line"></div><div class="line">    &lt;/filter&gt;</div><div class="line"></div><div class="line">    &lt;filter-mapping&gt;</div><div class="line">        &lt;!-- CORS Filter mapping --&gt;</div><div class="line">        &lt;filter-name&gt;CORS&lt;/filter-name&gt;</div><div class="line">        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">    &lt;/filter-mapping&gt;</div></pre></td></tr></table></figure>
<p>请注意,以上配置文件请放到web.xml的前面,作为第一个filter存在(可以有多个filter的)</p>
<ul>
<li>第四步:可能的安全模块配置错误(注意，某些框架中-譬如公司私人框架，有安全模块的，有时候这些安全模块配置会影响跨域配置，这时候可以先尝试关闭它们)</li>
</ul>
<h3 id="NET后台配置"><a href="#NET后台配置" class="headerlink" title="NET后台配置"></a>NET后台配置</h3><p>.NET后台配置可以参考如下步骤:</p>
<ul>
<li>第一步:网站配置</li>
</ul>
<p>打开控制面板，选择管理工具,选择iis;右键单击自己的网站，选择浏览;打开网站所在目录,用记事本打开web.config文件添加下述配置信息,重启网站</p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfxokvtvgj311u0gskf0.jpg" alt=""></p>
<p>请注意,以上截图较老,如果配置仍然出问题,可以考虑增加更多的headers允许,比如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"Access-Control-Allow-Headers"</span>:<span class="string">"X-Requested-With,Content-Type,Accept,Origin"</span></div></pre></td></tr></table></figure>
<ul>
<li><p>第二步:其它更多配置,如果第一步进行了后,仍然有跨域问题，可能是:</p>
<ul>
<li><p>接口中有限制死一些请求类型(比如写死了POST等)，这时候请去除限制</p>
</li>
<li><p>接口中，重复配置了<code>Origin:*</code>，请去除即可</p>
</li>
<li><p>IIS服务器中，重复配置了<code>Origin:*</code>，请去除即可</p>
</li>
</ul>
</li>
</ul>
<h3 id="代理请求方式解决接口跨域问题"><a href="#代理请求方式解决接口跨域问题" class="headerlink" title="代理请求方式解决接口跨域问题"></a>代理请求方式解决接口跨域问题</h3><p>注意，由于接口代理是有代价的，所以这个仅是开发过程中进行的。</p>
<p>与前面的方法不同，前面CROS是后端解决，而这个主要是前端对接口进行代理，也就是:</p>
<ul>
<li><p>前端ajax请求的是本地接口</p>
</li>
<li><p>本地接口接收到请求后向实际的接口请求数据，然后再将信息返回给前端</p>
</li>
<li><p>一般用node.js即可代理</p>
</li>
</ul>
<p>关于如何实现代理，这里就不重点描述了，方法很多，也不难，基本都是基于node.js的。</p>
<p>搜索关键字<code>node.js</code>,<code>代理请求</code>即可找到一大票的方案。</p>
<h2 id="如何分析ajax跨域"><a href="#如何分析ajax跨域" class="headerlink" title="如何分析ajax跨域"></a>如何分析ajax跨域</h2><p>上述已经介绍了跨域的原理以及如何解决，但实际过程中，发现仍然有很多人对照着类似的文档无法解决跨域问题，主要体现在，前端人员不知道什么时候是跨域问题造成的，什么时候不是，因此这里稍微介绍下如何分析一个请求是否跨域:</p>
<h3 id="抓包请求数据"><a href="#抓包请求数据" class="headerlink" title="抓包请求数据"></a>抓包请求数据</h3><p>第一步当然是得知道我们的ajax请求发送了什么数据，接收了什么，做到这一步并不难，也不需要<code>fiddler</code>等工具，仅基于<code>Chrome</code>即可</p>
<ul>
<li><p><code>Chrome</code>浏览器打开对应发生ajax的页面，<code>F12</code>打开<code>Dev Tools</code></p>
</li>
<li><p>发送ajax请求</p>
</li>
</ul>
<p>右侧面板-&gt;<code>NetWork</code>-&gt;<code>XHR</code>，然后找到刚才的ajax请求，点进去</p>
<h3 id="示例一-正常的ajax请求"><a href="#示例一-正常的ajax请求" class="headerlink" title="示例一(正常的ajax请求)"></a>示例一(正常的ajax请求)</h3><p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfxva8nnlj30ib0okjw1.jpg" alt=""></p>
<p>上述请求是一个正确的请求，为了方便，我把每一个头域的意思都表明了，我们可以清晰的看到，接口返回的响应头域中，包括了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Access-Control-Allow-Headers: X-Requested-With,Content-Type,Accept</div><div class="line">Access-Control-Allow-Methods: Get,Post,Put,OPTIONS</div><div class="line">Access-Control-Allow-Origin: *</div></pre></td></tr></table></figure>
<p>所以浏览器接收到响应时，判断的是正确的请求，自然不会报错，成功的拿到了响应数据。</p>
<h2 id="示例二-跨域错误的ajax请求"><a href="#示例二-跨域错误的ajax请求" class="headerlink" title="示例二(跨域错误的ajax请求)"></a>示例二(跨域错误的ajax请求)</h2><p>为了方便，我们仍然拿上面的错误表现示例举例。</p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfy5g00gij30nu0bu40c.jpg" alt=""></p>
<p>这个请求中，接口Allow里面没有包括<code>OPTIONS</code>，所以请求出现了跨域。</p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfy6fz95ij30ya0megzm.jpg" alt=""></p>
<p>这个请求中，<code>Access-Control-Allow-Origin: *</code>出现了两次，导致了跨域配置没有正确配置，出现了错误。</p>
<p>更多跨域错误基本都是类似的，就是以上三样没有满足(Headers,Allow,Origin)，这里不再一一赘述。</p>
<h2 id="示例三-与跨域无关的ajax请求"><a href="#示例三-与跨域无关的ajax请求" class="headerlink" title="示例三(与跨域无关的ajax请求)"></a>示例三(与跨域无关的ajax请求)</h2><p>当然，也并不是所有的ajax请求错误都与跨域有关，所以请不要混淆，比如以下:</p>
<p><img src="https://ws1.sinaimg.cn/large/006d7zD3gy1fhfy82b7x8j30i80cjgnd.jpg" alt=""></p>
<p>比如这个请求，它的跨域配置没有一点问题，它出错仅仅是因为request的<code>Accept</code>和response的<code>Content-Type</code>不匹配而已。</p>
<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>基本上都是这样去分析一个ajax请求，通过<code>Chrome</code>就可以知道了发送了什么数据，收到了什么数据，然后再一一比对就知道问题何在了。</p>
<h3 id="写在最后的话"><a href="#写在最后的话" class="headerlink" title="写在最后的话"></a>写在最后的话</h3><p>跨域是一个老生常谈的话题，网上也有大量跨域的资料，并且有不少精品(比如阮一峰前辈的)，但是身为一个前端人员不应该浅尝而止，故而才有了本文。</p>
<p>漫漫前端路，望与诸君共勉之！</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><p><a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html">浏览器同源政策及其规避方法(阮一峰)</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解(阮一峰)</a></p>
</li>
</ul>
<h4 id="原文地址：ajax跨域，这应该是最全的解决方案了"><a href="#原文地址：ajax跨域，这应该是最全的解决方案了" class="headerlink" title="原文地址：ajax跨域，这应该是最全的解决方案了"></a>原文地址：<a href="http://www.jianshu.com/p/82b82d5dd1ea">ajax跨域，这应该是最全的解决方案了</a></h4></script></p>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/javascript/" rel="tag"># javascript</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/11/html_HTML5表单功能/" rel="next" title="HTML5表单功能">
                <i class="fa fa-chevron-left"></i> HTML5表单功能
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/toux.jpg"
               alt="郭天琦" />
          <p class="site-author-name" itemprop="name">郭天琦</p>
           
              <p class="site-description motion-element" itemprop="description">不积跬步无以至千里，不积小流无以成江海</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#题纲"><span class="nav-number">2.</span> <span class="nav-text">题纲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是ajax跨域"><span class="nav-number">3.</span> <span class="nav-text">什么是ajax跨域</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ajax跨域的原理"><span class="nav-number">3.1.</span> <span class="nav-text">ajax跨域的原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CROS请求原理"><span class="nav-number">3.2.</span> <span class="nav-text">CROS请求原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#如何判断是否是简单请求"><span class="nav-number">3.2.1.</span> <span class="nav-text">如何判断是否是简单请求?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ajax跨域的表现"><span class="nav-number">3.2.2.</span> <span class="nav-text">ajax跨域的表现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何解决ajax跨域"><span class="nav-number">4.</span> <span class="nav-text">如何解决ajax跨域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSONP方式解决跨域问题"><span class="nav-number">5.</span> <span class="nav-text">JSONP方式解决跨域问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实现原理"><span class="nav-number">5.1.</span> <span class="nav-text">实现原理</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">郭天琦</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

</body>
</html>
